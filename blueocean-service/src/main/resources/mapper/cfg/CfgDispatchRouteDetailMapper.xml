<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.teekee.blueoceanservice.mapper.cfg.CfgDispatchRouteDetailMapper">
  <resultMap id="BaseResultMap" type="com.teekee.blueoceanservice.entity.cfg.CfgDispatchRouteDetail">
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="route_id" jdbcType="INTEGER" property="routeId" />
    <result column="province" jdbcType="VARCHAR" property="province" />
    <result column="region" jdbcType="VARCHAR" property="region" />
    <result column="emergency_person" jdbcType="VARCHAR" property="emergencyPerson" />
    <result column="no_emergency_person" jdbcType="VARCHAR" property="noEmergencyPerson" />
    <result column="flag_default" jdbcType="BIT" property="flagDefault" />
    <result column="colour" jdbcType="VARCHAR" property="colour" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="create_person" jdbcType="INTEGER" property="createPerson" />
  </resultMap>
  <sql id="Base_Column_List">
    id, route_id, province, region, emergency_person, no_emergency_person, flag_default, 
    colour, create_time, create_person
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from cfg_dispatch_route_detail
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete from cfg_dispatch_route_detail
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.teekee.blueoceanservice.entity.cfg.CfgDispatchRouteDetail">
    insert into cfg_dispatch_route_detail (id, route_id, province, 
      region, emergency_person, no_emergency_person, 
      flag_default, colour, create_time, 
      create_person)
    values (#{id,jdbcType=INTEGER}, #{routeId,jdbcType=INTEGER}, #{province,jdbcType=VARCHAR}, 
      #{region,jdbcType=VARCHAR}, #{emergencyPerson,jdbcType=VARCHAR}, #{noEmergencyPerson,jdbcType=VARCHAR}, 
      #{flagDefault,jdbcType=BIT}, #{colour,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{createPerson,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="com.teekee.blueoceanservice.entity.cfg.CfgDispatchRouteDetail">
    insert into cfg_dispatch_route_detail
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="routeId != null">
        route_id,
      </if>
      <if test="province != null">
        province,
      </if>
      <if test="region != null">
        region,
      </if>
      <if test="emergencyPerson != null">
        emergency_person,
      </if>
      <if test="noEmergencyPerson != null">
        no_emergency_person,
      </if>
      <if test="flagDefault != null">
        flag_default,
      </if>
      <if test="colour != null">
        colour,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="createPerson != null">
        create_person,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=INTEGER},
      </if>
      <if test="routeId != null">
        #{routeId,jdbcType=INTEGER},
      </if>
      <if test="province != null">
        #{province,jdbcType=VARCHAR},
      </if>
      <if test="region != null">
        #{region,jdbcType=VARCHAR},
      </if>
      <if test="emergencyPerson != null">
        #{emergencyPerson,jdbcType=VARCHAR},
      </if>
      <if test="noEmergencyPerson != null">
        #{noEmergencyPerson,jdbcType=VARCHAR},
      </if>
      <if test="flagDefault != null">
        #{flagDefault,jdbcType=BIT},
      </if>
      <if test="colour != null">
        #{colour,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createPerson != null">
        #{createPerson,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.teekee.blueoceanservice.entity.cfg.CfgDispatchRouteDetail">
    update cfg_dispatch_route_detail
    <set>
      <if test="routeId != null">
        route_id = #{routeId,jdbcType=INTEGER},
      </if>
      <if test="province != null">
        province = #{province,jdbcType=VARCHAR},
      </if>
      <if test="region != null">
        region = #{region,jdbcType=VARCHAR},
      </if>
      <if test="emergencyPerson != null">
        emergency_person = #{emergencyPerson,jdbcType=VARCHAR},
      </if>
      <if test="noEmergencyPerson != null">
        no_emergency_person = #{noEmergencyPerson,jdbcType=VARCHAR},
      </if>
      <if test="flagDefault != null">
        flag_default = #{flagDefault,jdbcType=BIT},
      </if>
      <if test="colour != null">
        colour = #{colour,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createPerson != null">
        create_person = #{createPerson,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.teekee.blueoceanservice.entity.cfg.CfgDispatchRouteDetail">
    update cfg_dispatch_route_detail
    set route_id = #{routeId,jdbcType=INTEGER},
      province = #{province,jdbcType=VARCHAR},
      region = #{region,jdbcType=VARCHAR},
      emergency_person = #{emergencyPerson,jdbcType=VARCHAR},
      no_emergency_person = #{noEmergencyPerson,jdbcType=VARCHAR},
      flag_default = #{flagDefault,jdbcType=BIT},
      colour = #{colour,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      create_person = #{createPerson,jdbcType=INTEGER}
    where id = #{id,jdbcType=INTEGER}
  </update>

  <!--根据routeId删除-->
  <delete id="deleteByRoute" parameterType="java.lang.Integer">
    delete from cfg_dispatch_route_detail
    where route_id = #{routeId,jdbcType=INTEGER}
  </delete>




  <!-- 批量插入数据 -->
  <insert id="insertBatch" parameterType="java.util.List">
    insert into
    cfg_dispatch_route_detail ( route_id, province,
    region, emergency_person, no_emergency_person, create_time)
    values
    <foreach collection="list" item="item" index="index"
             separator=",">
      (
      #{item.routeId},#{item.province},#{item.region},
      #{item.emergencyPerson},#{item.noEmergencyPerson},now()
      )
    </foreach>
  </insert>




  <!--批量更新-->
  <update id="updateBatch" parameterType="java.util.List">
    update cfg_dispatch_route_detail
    <trim prefix="set" suffixOverrides=",">
      <trim prefix="province =case" suffix="end,">
        <foreach collection="list" item="item" index="index">
          when id=#{item.id} then #{item.province}
        </foreach>
      </trim>

      <trim prefix="region =case" suffix="end,">
        <foreach collection="list" item="item" index="index">
          when id=#{item.id} then #{item.region}
        </foreach>
      </trim>

      <trim prefix="emergency_person =case" suffix="end,">
        <foreach collection="list" item="item" index="index">
          when id=#{item.id} then #{item.emergencyPerson}
        </foreach>
      </trim>

      <trim prefix="no_emergency_person =case" suffix="end,">
        <foreach collection="list" item="item" index="index">
          when id=#{item.id} then #{item.noEmergencyPerson}
        </foreach>
      </trim>

    </trim>
    where id in
    <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
      #{item.id,jdbcType=BIGINT}
    </foreach>
  </update>






  <!--细则列表-->
  <select id="selectTree" parameterType="java.lang.Integer" resultType="com.teekee.blueoceanservice.entity.cfg.CfgDispatchRouteDetail">

    SELECT region.id id,
        region.region_name region,
        route.id detailId,
        region.parent_id parentId,

        CASE WHEN route.id IS NOT NULL
        THEN
        CONCAT(region.region_name,"      [急: ",(SELECT GROUP_CONCAT(DISTINCT(username))
        FROM sys_company_users WHERE  find_in_set(id,route.emergency_person)),
        "      不急: ",(SELECT GROUP_CONCAT(DISTINCT(username))
        FROM sys_company_users WHERE  find_in_set(id, route.no_emergency_person)),"]")
        ELSE region.region_name END personMsg,

        #{id} routeId,
        CASE WHEN route.emergency_person is not null OR route.no_emergency_person is not null
        OR region.region_name in (

        SELECT f.province FROM
        (SELECT a.region_name,COUNT(a.region_name) count1
        FROM cfg_region a
        LEFT JOIN cfg_region b ON b.parent_id=a.id
        WHERE a.`level`=2  GROUP BY a.region_name) s
        LEFT JOIN
        (SELECT d.province,COUNT(1) count2 FROM cfg_dispatch_route_detail d
        WHERE d.route_id=#{id,jdbcType=INTEGER} AND d.flag_default=0 GROUP BY d.province) f ON s.region_name=f.province
        WHERE s.count1=f.count2

        ) OR (region.parent_id=0 AND
				(SELECT COUNT(1) FROM cfg_region WHERE `level`=3 AND region_name is NOT NULL AND region_name!='')
					=
				(SELECT COUNT(1) FROM cfg_dispatch_route_detail WHERE route_id=#{id,jdbcType=INTEGER})
				)
        THEN 1
		ELSE 0 END checkStatus
    FROM cfg_region region
    LEFT JOIN cfg_dispatch_route_detail route
    ON region.region_name=route.region and route.route_id=#{id,jdbcType=INTEGER} AND route.flag_default=0
    WHERE region.`level` NOT in (0,4) AND region.region_name is NOT NULL AND region.region_name!=''
    ORDER BY region.id
  </select>

</mapper>